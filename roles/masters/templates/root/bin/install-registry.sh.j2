#!/bin/bash
set -e

#pvcreate /dev/{{ collecd_disk_ose_registry }}
#vgcreate vg_ose /dev/{{ collecd_disk_ose_registry }}
#lvcreate -l 100%FREE --name ose-registry vg_ose
#mkdir /mnt/ose-registry
#mkfs.ext4 -m0 /dev/mapper/vg_ose-ose--registry
#echo '/dev/mapper/vg_ose-ose--registry /mnt/ose-registry ext4 rw,noatime,data=ordered 0 0' >> /etc/fstab
#mount -a

#delete registry
oc delete dc docker-registry
oc delete svc docker-registry
oc delete pod docker-registry-1-deploy

#For <=3.0.1 First setup, need to create ServiceAccount
#echo \
#    '{"kind":"ServiceAccount","apiVersion":"v1","metadata":{"name":"registry"}}' \
#    | oc create -f -

#oc edit scc privileged
#Add a line under users with the user name system:serviceaccount:default:registry.

#oadm manage-node {{ inventory_hostname }} --schedulable=true

oadm registry --create --service-account=registry \
  --config=/etc/{{ masters_etc_config }}/master/admin.kubeconfig \
  --credentials=/etc/{{ masters_etc_config }}/master/openshift-registry.kubeconfig \
  --mount-host={{openshift_registry_mount_host}} --selector="region=infra"
#  --images='registry.access.redhat.com/openshift3/ose-${component}:${version}' \

#oadm manage-node {{ inventory_hostname }} --schedulable=false
